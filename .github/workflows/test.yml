# E2E Test Pipeline
# Generated by TEA CI Workflow
#
# Features:
# - Dependency caching (npm, Playwright browsers)
# - Burn-in testing for changed specs (flaky detection)
# - Parallel sharding (4 shards)
# - Artifact collection (HTML report, JUnit XML, traces)
# - Report aggregation and PR comments

name: E2E Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch: # Manual trigger

env:
  NODE_VERSION_FILE: '.nvmrc'
  PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Stage 1: Install & Cache Dependencies
  # ============================================
  install:
    name: Install Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      cache-hit: ${{ steps.npm-cache.outputs.cache-hit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ${{ env.NODE_VERSION_FILE }}
          cache: 'npm'

      - name: Cache node_modules
        id: npm-cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}-pw-${{ hashFiles('playwright.config.ts') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: Install Playwright browsers
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

  # ============================================
  # Stage 2: Lint (Optional)
  # ============================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: install
    timeout-minutes: 5
    continue-on-error: true # Don't block tests on lint failures
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ${{ env.NODE_VERSION_FILE }}
          cache: 'npm'

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}-pw-${{ hashFiles('playwright.config.ts') }}

      - name: Run lint
        run: npm run lint --if-present

  # ============================================
  # Stage 3: Burn-in Changed Specs
  # ============================================
  burn-in:
    name: Burn-in Changed Tests
    runs-on: ubuntu-latest
    needs: install
    if: github.event_name == 'pull_request'
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for git diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ${{ env.NODE_VERSION_FILE }}
          cache: 'npm'

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}-pw-${{ hashFiles('playwright.config.ts') }}

      - name: Detect changed test files
        id: changed
        run: |
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(spec|test)\.(ts|js)$' || echo "")
          echo "specs=${CHANGED}" >> $GITHUB_OUTPUT
          if [ -n "$CHANGED" ]; then
            echo "::notice::Changed test files: $CHANGED"
          else
            echo "::notice::No test files changed"
          fi

      - name: Run burn-in (5 iterations)
        if: steps.changed.outputs.specs != ''
        run: |
          SPECS="${{ steps.changed.outputs.specs }}"
          echo "üî• Running burn-in: 5 iterations on changed specs"
          for i in 1 2 3 4 5; do
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üîÑ Burn-in iteration $i/5"
            npx playwright test $SPECS --reporter=list || {
              echo "‚ùå Burn-in failed on iteration $i"
              exit 1
            }
          done
          echo "‚úÖ Burn-in passed: 5/5 successful runs"
        env:
          CI: true

      - name: Upload burn-in artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: burn-in-failures
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # ============================================
  # Stage 4: E2E Tests (Sharded)
  # ============================================
  test:
    name: E2E Tests (Shard ${{ matrix.shard }}/4)
    runs-on: ubuntu-latest
    needs: [install, burn-in]
    if: always() && needs.install.result == 'success'
    timeout-minutes: 30
    strategy:
      fail-fast: false # Run all shards even if one fails
      matrix:
        shard: [1, 2, 3, 4]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ${{ env.NODE_VERSION_FILE }}
          cache: 'npm'

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}-pw-${{ hashFiles('playwright.config.ts') }}

      - name: Run E2E tests (shard ${{ matrix.shard }}/4)
        run: npx playwright test --shard=${{ matrix.shard }}/4
        env:
          CI: true
          BASE_URL: ${{ vars.BASE_URL || 'http://localhost:3000' }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-shard-${{ matrix.shard }}
          path: |
            test-results/
          retention-days: 30

      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shard }}
          path: blob-report/
          retention-days: 7

  # ============================================
  # Stage 5: Merge Reports
  # ============================================
  report:
    name: Merge Reports
    runs-on: ubuntu-latest
    needs: test
    if: always()
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ${{ env.NODE_VERSION_FILE }}
          cache: 'npm'

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}-pw-${{ hashFiles('playwright.config.ts') }}

      - name: Download all blob reports
        uses: actions/download-artifact@v4
        with:
          pattern: blob-report-*
          path: all-blob-reports
          merge-multiple: true

      - name: Merge reports
        run: npx playwright merge-reports --reporter=html,junit ./all-blob-reports
        continue-on-error: true

      - name: Upload merged HTML report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload JUnit report
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: results.xml
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: daun/playwright-report-comment@v3
        with:
          report-path: playwright-report/

  # ============================================
  # Stage 6: Publish Report (GitHub Pages)
  # ============================================
  publish:
    name: Publish Report
    runs-on: ubuntu-latest
    needs: report
    if: github.ref == 'refs/heads/main' && always()
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download HTML report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: playwright-report/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
